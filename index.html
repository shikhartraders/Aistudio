<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>AI Studio | Elite Apex</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Kalam:wght@700&display=swap" rel="stylesheet">

<style>
/* ================= THEME ENGINE ================= */
:root {
  --bg-deep: #000000;
  --bg-glass: rgba(10, 10, 10, 0.85);
  --bg-card: #0f0f0f;
  
  /* Default Gold Theme */
  --primary: #D4AF37;
  --accent: #FFD700;
  --gradient: linear-gradient(135deg, #D4AF37, #8E7108);
  --shadow-color: rgba(212, 175, 55, 0.2);
  
  --text-main: #FFFFFF;
  --text-muted: #888;
  
  --font-brand: 'Cinzel', serif;
  --font-body: 'Inter', sans-serif;
  --font-code: 'JetBrains Mono', monospace;
  
  --radius-xl: 24px;
  --radius-md: 12px;
}

/* Cyberpunk Theme Override */
[data-theme="cyber"] {
  --primary: #00f3ff;
  --accent: #bc13fe;
  --gradient: linear-gradient(135deg, #00f3ff, #bc13fe);
  --shadow-color: rgba(0, 243, 255, 0.3);
}

* { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg-deep); color: var(--text-main); font-family: var(--font-body);
  height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
  transition: background 0.5s;
}

/* ================= 1. APEX SPLASH SCREEN ================= */
#splash {
  position: fixed; inset: 0; background: #000; z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.8s ease, visibility 0.8s;
}
.splash-content { position: relative; text-align: center; }
.splash-title {
  font-family: var(--font-brand); font-size: 4rem; letter-spacing: 4px;
  background: var(--gradient); -webkit-background-clip: text; background-clip: text; color: transparent;
  animation: pulseGradient 3s infinite;
}
.splash-sub {
  font-size: 0.9rem; letter-spacing: 6px; color: #555; margin-top: 10px; text-transform: uppercase;
  opacity: 0; animation: fadeInUp 1s ease 0.5s forwards;
}
.loader-ring {
  width: 60px; height: 60px; margin-top: 30px; border: 2px solid rgba(255,255,255,0.1);
  border-top-color: var(--primary); border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes pulseGradient { 0% { filter: brightness(1); } 50% { filter: brightness(1.3); } 100% { filter: brightness(1); } }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes spin { to { transform: rotate(360deg); } }

/* ================= 2. APP LAYOUT ================= */
#app-interface {
  display: flex; flex-direction: column; height: 100%; opacity: 0; visibility: hidden; transition: opacity 1s;
}

/* Header */
header {
  height: 70px; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;
  background: var(--bg-glass); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255,255,255,0.05);
  z-index: 100;
}
.brand { font-family: var(--font-brand); font-weight: 700; font-size: 1.4rem; color: var(--primary); }

.header-tools { display: flex; gap: 15px; align-items: center; }
.tool-icon { background: none; border: none; color: #666; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
.tool-icon:hover { color: var(--primary); }

.avatar-container {
  width: 40px; height: 40px; border-radius: 50%; padding: 2px;
  border: 1px solid var(--primary); cursor: pointer; position: relative;
}
.avatar-img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.status-dot {
  position: absolute; bottom: 0; right: 0; width: 10px; height: 10px;
  background: #00ff88; border: 2px solid #000; border-radius: 50%;
}

/* Chat Area */
#chat-viewport {
  flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 25px;
  scroll-behavior: smooth;
}

/* Messages */
.msg-row { display: flex; width: 100%; animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
@keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.msg-row.user { justify-content: flex-end; }
.msg-row.ai { justify-content: flex-start; }

.bubble {
  max-width: 85%; padding: 16px 20px; border-radius: var(--radius-xl);
  font-size: 0.95rem; line-height: 1.6; position: relative; word-wrap: break-word;
}
.user .bubble {
  background: var(--gradient); color: #000; border-bottom-right-radius: 4px;
  font-weight: 600; box-shadow: 0 5px 20px var(--shadow-color);
}
.ai .bubble {
  background: #111; border: 1px solid #333; color: #eee; border-bottom-left-radius: 4px;
}
/* Whiteboard Mode */
.ai .bubble.whiteboard {
  background: #fdfbf7; color: #2c3e50; font-family: 'Kalam', cursive;
  font-weight: 700; font-size: 1.1rem; border: 3px solid #222;
  box-shadow: 5px 5px 0 rgba(0,0,0,0.5); transform: rotate(-1deg);
}

/* Attachments */
.attachment-preview { max-width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #444; }
.file-badge {
  background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px;
  display: inline-flex; align-items: center; gap: 8px; font-family: var(--font-code); font-size: 0.8rem;
}

/* Code Blocks */
pre {
  background: #0a0a0a; border: 1px solid #333; border-radius: 12px; margin: 15px 0;
  position: relative; overflow: hidden;
}
code { font-family: var(--font-code); font-size: 0.85rem; padding: 20px; display: block; overflow-x: auto; }

/* Action Buttons (Copy, Run, Speak) */
.code-actions {
  position: absolute; top: 0; right: 0; display: flex; background: #222;
  border-bottom-left-radius: 10px; overflow: hidden;
}
.action-mini-btn {
  background: transparent; border: none; color: #888; padding: 6px 12px;
  font-size: 0.7rem; cursor: pointer; border-left: 1px solid #333; display: flex; gap: 5px; align-items: center;
}
.action-mini-btn:hover { background: var(--primary); color: #000; }

/* AI Message Tools */
.msg-toolbar { display: flex; gap: 10px; margin-top: 8px; opacity: 0.5; transition: 0.3s; }
.msg-toolbar:hover { opacity: 1; }
.tb-btn { background: none; border: none; color: #fff; cursor: pointer; font-size: 0.9rem; }
.tb-btn:hover { color: var(--primary); }

/* Input Area */
#input-area {
  background: #000; border-top: 1px solid #222; padding: 15px 20px 30px 20px; z-index: 50;
}
.input-wrapper {
  background: #111; border: 1px solid #333; border-radius: 16px;
  display: flex; align-items: center; padding: 8px; transition: border 0.3s;
}
.input-wrapper:focus-within { border-color: var(--primary); }

#user-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; padding: 0 10px; height: 40px; }

.input-actions { display: flex; gap: 5px; }
.icon-btn {
  width: 40px; height: 40px; border-radius: 10px; border: none; background: transparent;
  color: #888; font-size: 1.1rem; cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.icon-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
.icon-btn.active-mic { color: #ff4444; animation: pulseMic 1.5s infinite; }
@keyframes pulseMic { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

.send-btn {
  width: 45px; height: 45px; border-radius: 12px; background: var(--primary);
  border: none; color: #000; font-size: 1.2rem; cursor: pointer; margin-left: 5px;
  display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
}
.send-btn:active { transform: scale(0.95); }

/* ================= 3. SETTINGS & PROFILE HUB ================= */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000;
  display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
}
.modal-backdrop.open { display: flex; animation: fadeIn 0.3s; }

.hub-card {
  width: 90%; max-width: 420px; background: #0a0a0a; border: 1px solid #333;
  border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;
  max-height: 85vh; box-shadow: 0 0 50px rgba(0,0,0,0.5);
}

.hub-header {
  background: linear-gradient(to bottom, #111, #000); padding: 30px 20px;
  text-align: center; border-bottom: 1px solid #222; position: relative;
}
.hub-avatar-lg {
  width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary);
  object-fit: cover; margin-bottom: 15px; box-shadow: 0 0 20px var(--shadow-color);
}
.hub-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer; }

.hub-body { padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
.hub-label { font-size: 0.75rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: block; }
.hub-input {
  width: 100%; background: #151515; border: 1px solid #333; padding: 14px;
  border-radius: 10px; color: #fff; font-family: var(--font-body);
}
.hub-btn-primary {
  width: 100%; background: var(--primary); color: #000; padding: 15px;
  border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px;
}

/* Hidden Inputs */
#file-input-cam, #file-input-gal, #avatar-upload { display: none; }

/* Preview Modal */
#preview-overlay {
  position: fixed; inset: 0; background: #fff; z-index: 6000; display: none; flex-direction: column;
}
#preview-frame { flex: 1; border: none; }
.preview-bar { height: 50px; background: #f0f0f0; display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; border-bottom: 1px solid #ccc; }
.close-prev { color: #000; font-weight: bold; cursor: pointer; border: 1px solid #ccc; padding: 5px 15px; border-radius: 5px; }

</style>
</head>
<body>

<div id="splash">
  <div class="splash-content">
    <div class="splash-title">AI STUDIO</div>
    <div class="splash-sub">Elite Apex Edition v6.0</div>
    <div class="loader-ring"></div>
  </div>
</div>

<div id="app-interface">
  
  <header>
    <div class="brand">AI STUDIO</div>
    <div class="header-tools">
      <button class="tool-icon" onclick="toggleTheme()" title="Switch Theme"><i class="fa-solid fa-palette"></i></button>
      <button class="tool-icon" onclick="exportPDF()" title="Download PDF"><i class="fa-solid fa-file-pdf"></i></button>
      <div class="avatar-container" onclick="openHub()">
        <img src="" id="header-avatar" class="avatar-img">
        <div class="status-dot"></div>
      </div>
    </div>
  </header>

  <div id="chat-viewport">
    <div class="msg-row ai">
      <div class="bubble">
        <strong>System Online.</strong><br>
        Welcome to the Apex Edition. I am ready to see, hear, and code.<br><br>
        <em>Try uploading a code file or image using the paperclip.</em>
      </div>
    </div>
  </div>

  <div id="input-area">
    <div class="input-wrapper">
      <button class="icon-btn" onclick="triggerFileSelect()" title="Attach File/Image">
        <i class="fa-solid fa-paperclip"></i>
      </button>
      <input type="file" id="file-input-gal" onchange="handleFile(this)">
      
      <button class="icon-btn" onclick="document.getElementById('file-input-cam').click()" title="Camera">
        <i class="fa-solid fa-camera"></i>
      </button>
      <input type="file" id="file-input-cam" accept="image/*" capture="environment" onchange="handleFile(this)">

      <input type="text" id="user-input" placeholder="Type or speak..." autocomplete="off">
      
      <button class="icon-btn" id="mic-btn" onclick="toggleMic()">
        <i class="fa-solid fa-microphone"></i>
      </button>

      <button class="send-btn" onclick="sendMessage()">
        <i class="fa-solid fa-arrow-up"></i>
      </button>
    </div>
    
    <div style="text-align:center; margin-top:15px; color:#444; font-size:0.65rem; letter-spacing:2px; font-family:var(--font-brand);">
      POWERED BY SHIKHAR PANDEY ELITE ENGINE
    </div>
  </div>

</div>

<div id="hub-modal" class="modal-backdrop">
  <div class="hub-card">
    <div class="hub-header">
      <button class="hub-close" onclick="closeHub()">&times;</button>
      <img src="" id="hub-avatar" class="hub-avatar-lg" onclick="document.getElementById('avatar-upload').click()">
      <input type="file" id="avatar-upload" accept="image/*" onchange="updateAvatar(this)">
      <h2 style="color:#fff; font-size:1.2rem; margin:10px 0 0 0;" id="hub-name">User Name</h2>
      <span style="color:var(--primary); font-size:0.8rem; text-transform:uppercase;" id="hub-title">Role</span>
    </div>
    
    <div class="hub-body">
      <div>
        <span class="hub-label">Identity</span>
        <input type="text" id="prof-name" class="hub-input" placeholder="Your Name">
        <div style="height:10px;"></div>
        <input type="text" id="prof-title" class="hub-input" placeholder="Job Title">
      </div>
      
      <div>
        <span class="hub-label">Neural Bridge (API Key)</span>
        <input type="password" id="prof-key" class="hub-input" placeholder="OpenRouter / OpenAI Key">
      </div>

      <button class="hub-btn-primary" onclick="saveProfile()">SAVE CONFIGURATION</button>
    </div>
  </div>
</div>

<div id="preview-overlay">
  <div class="preview-bar">
    <button class="close-prev" onclick="closePreview()">Close Preview</button>
  </div>
  <iframe id="preview-frame"></iframe>
</div>

<script>
// ================= CORE CONFIGURATION =================
const DEFAULT_AVATAR = "https://ui-avatars.com/api/?name=User&background=D4AF37&color=000&size=128";
let user = { name: "Shikhar Traders", title: "Elite Admin", avatar: DEFAULT_AVATAR, apiKey: "" };
let pendingAttachment = null; // { type: 'image'|'file', data: 'base64...', name: 'filename' }
let recognition = null; // Speech Recognition

// ================= INITIALIZATION =================
window.onload = function() {
  loadProfile();
  initSpeech();
  
  // Splash Logic
  setTimeout(() => {
    document.getElementById('splash').style.opacity = '0';
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      document.getElementById('app-interface').style.visibility = 'visible';
      document.getElementById('app-interface').style.opacity = '1';
    }, 800);
  }, 2500);

  // Setup Syntax Highlighting
  hljs.highlightAll();

  // Enter Key Listener
  document.getElementById('user-input').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendMessage();
  });
};

// ================= PROFILE SYSTEM =================
function loadProfile() {
  const saved = localStorage.getItem("elite_profile_v6");
  if(saved) user = JSON.parse(saved);
  updateUI();
  if(!user.apiKey) setTimeout(openHub, 3000);
}

function updateUI() {
  document.getElementById('header-avatar').src = user.avatar;
  document.getElementById('hub-avatar').src = user.avatar;
  document.getElementById('hub-name').innerText = user.name;
  document.getElementById('hub-title').innerText = user.title;
  document.getElementById('prof-name').value = user.name;
  document.getElementById('prof-title').value = user.title;
  document.getElementById('prof-key').value = user.apiKey;
}

function saveProfile() {
  user.name = document.getElementById('prof-name').value;
  user.title = document.getElementById('prof-title').value;
  user.apiKey = document.getElementById('prof-key').value;
  // Avatar is saved automatically on change
  localStorage.setItem("elite_profile_v6", JSON.stringify(user));
  updateUI();
  closeHub();
  addBubble("ai", `Profile Updated. Connected as ${user.name}.`);
}

function openHub() { document.getElementById('hub-modal').classList.add('open'); }
function closeHub() { document.getElementById('hub-modal').classList.remove('open'); }

function updateAvatar(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      user.avatar = e.target.result;
      document.getElementById('hub-avatar').src = user.avatar;
    }
    reader.readAsDataURL(input.files[0]);
  }
}

// ================= THEME ENGINE =================
function toggleTheme() {
  const body = document.body;
  if (body.getAttribute('data-theme') === 'cyber') {
    body.removeAttribute('data-theme');
  } else {
    body.setAttribute('data-theme', 'cyber');
  }
}

// ================= FILE HANDLING (IMAGES & CODE) =================
function triggerFileSelect() { document.getElementById('file-input-gal').click(); }

function handleFile(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const isImage = file.type.startsWith('image/');
      pendingAttachment = {
        type: isImage ? 'image' : 'file',
        data: e.target.result,
        name: file.name
      };
      
      const icon = isImage ? '<i class="fa-regular fa-image"></i>' : '<i class="fa-regular fa-file-code"></i>';
      document.getElementById('user-input').value = `[Attached: ${file.name}] `;
      document.getElementById('user-input').focus();
    }
    
    if (file.type.startsWith('image/')) {
      reader.readAsDataURL(file);
    } else {
      reader.readAsText(file); // Read code files as text
    }
  }
}

// ================= CHAT LOGIC =================
async function sendMessage() {
  const inputEl = document.getElementById('user-input');
  let text = inputEl.value.trim();
  
  if (!text && !pendingAttachment) return;
  if (!user.apiKey) { openHub(); return; }
  
  // Clean up input visual if it just says "[Attached...]"
  if(text.startsWith("[Attached:")) text = "Analyze this attachment.";

  // 1. Render User Message
  let userHtml = text;
  if (pendingAttachment) {
    if(pendingAttachment.type === 'image') {
      userHtml += `<br><img src="${pendingAttachment.data}" class="attachment-preview">`;
    } else {
      userHtml += `<br><div class="file-badge"><i class="fa-solid fa-file-code"></i> ${pendingAttachment.name}</div>`;
    }
  }
  addBubble("user", userHtml);
  inputEl.value = "";
  
  // 2. Loading State
  const loadId = addBubble("ai", '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...');
  
  // 3. Construct Payload
  let messages = [
    { role: "system", content: "You are an Elite AI. If asked to write code, provide full, runnable code. If Math, explain step-by-step. If asked to analyze a file, do so in detail." }
  ];
  
  let contentPayload = [];
  contentPayload.push({ type: "text", text: text });
  
  if (pendingAttachment) {
    if(pendingAttachment.type === 'image') {
      contentPayload.push({ type: "image_url", image_url: { url: pendingAttachment.data } });
    } else {
      contentPayload.push({ type: "text", text: `\n\n[FILE CONTENT OF ${pendingAttachment.name}]:\n${pendingAttachment.data}` });
    }
    pendingAttachment = null; // Reset
  }
  
  messages.push({ role: "user", content: contentPayload });

  // 4. API Call
  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${user.apiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "openai/gpt-4o-mini",
        messages: messages
      })
    });
    
    if(!res.ok) throw new Error("Connection Error");
    
    const data = await res.json();
    let reply = data.choices[0].message.content;
    
    // Remove loader
    const loader = document.getElementById(loadId);
    if(loader) loader.parentElement.remove();
    
    // Detect Whiteboard Mode
    let isWhiteboard = false;
    if (reply.includes("[WHITEBOARD]") || text.toLowerCase().includes("math") || text.toLowerCase().includes("physics")) {
      isWhiteboard = true;
      reply = reply.replace("[WHITEBOARD]", "");
    }
    
    addBubble("ai", reply, isWhiteboard);
    
  } catch (err) {
    const loader = document.getElementById(loadId);
    if(loader) loader.innerHTML = `Error: ${err.message}`;
  }
}

// ================= BUBBLE RENDERER =================
function addBubble(role, html, isWhiteboard = false) {
  const box = document.getElementById('chat-viewport');
  const row = document.createElement('div');
  row.className = `msg-row ${role}`;
  
  const bubble = document.createElement('div');
  bubble.className = `bubble ${isWhiteboard ? 'whiteboard' : ''}`;
  
  if (role === 'ai') {
    bubble.innerHTML = marked.parse(html);
    
    // Highlight Code
    bubble.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    
    // Add Buttons to Code Blocks (Copy & Preview)
    bubble.querySelectorAll('pre').forEach(pre => {
      const codeText = pre.querySelector('code').innerText;
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'code-actions';
      
      // Copy Button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'action-mini-btn';
      copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i> Copy';
      copyBtn.onclick = () => { navigator.clipboard.writeText(codeText); alert('Copied!'); };
      actionsDiv.appendChild(copyBtn);
      
      // Run Button (Only for HTML)
      if (codeText.trim().startsWith('<html') || codeText.trim().startsWith('<!DOCTYPE')) {
        const runBtn = document.createElement('button');
        runBtn.className = 'action-mini-btn';
        runBtn.innerHTML = '<i class="fa-solid fa-play"></i> Preview';
        runBtn.onclick = () => openPreview(codeText);
        actionsDiv.appendChild(runBtn);
      }
      
      pre.appendChild(actionsDiv);
    });
    
    // Add Message Toolbar (Speak)
    const toolbar = document.createElement('div');
    toolbar.className = 'msg-toolbar';
    toolbar.innerHTML = `
      <button class="tb-btn" onclick="speakText(this.parentElement.parentElement.innerText)"><i class="fa-solid fa-volume-high"></i></button>
    `;
    bubble.appendChild(toolbar);
    
  } else {
    bubble.innerHTML = html;
  }
  
  const id = "msg-" + Date.now();
  bubble.id = id;
  
  row.appendChild(bubble);
  box.appendChild(row);
  box.scrollTop = box.scrollHeight;
  return id;
}

// ================= TOOLS (TTS, STT, PDF, PREVIEW) =================

// 1. Text to Speech
function speakText(text) {
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text.replace(/Copy|Preview/g, '').substring(0, 500));
  window.speechSynthesis.speak(u);
}

// 2. Speech to Text
function initSpeech() {
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = (event) => {
      const text = event.results[0][0].transcript;
      document.getElementById('user-input').value = text;
      toggleMic(); // Turn off visual
      sendMessage();
    };
    
    recognition.onerror = () => toggleMic();
    recognition.onend = () => document.getElementById('mic-btn').classList.remove('active-mic');
  }
}

function toggleMic() {
  if (!recognition) return alert("Voice input not supported in this browser.");
  const btn = document.getElementById('mic-btn');
  if (btn.classList.contains('active-mic')) {
    recognition.stop();
    btn.classList.remove('active-mic');
  } else {
    recognition.start();
    btn.classList.add('active-mic');
  }
}

// 3. PDF Export
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont("courier");
  doc.text(`SESSION LOG - ${user.name}`, 10, 10);
  let y = 20;
  
  document.querySelectorAll('.bubble').forEach(b => {
    const raw = b.innerText.replace("Copy", "").replace("Preview", "");
    const lines = doc.splitTextToSize(raw, 180);
    doc.text(lines, 10, y);
    y += (lines.length * 5) + 10;
    if(y > 270) { doc.addPage(); y = 10; }
  });
  doc.save("Chat_Log.pdf");
}

// 4. Code Preview
function openPreview(code) {
  const overlay = document.getElementById('preview-overlay');
  const frame = document.getElementById('preview-frame');
  overlay.style.display = 'flex';
  const doc = frame.contentWindow.document;
  doc.open();
  doc.write(code);
  doc.close();
}
function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }

</script>
</body>
</html>