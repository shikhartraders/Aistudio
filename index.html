<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>AI Studio | Ai Studio</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark-reasonable.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

<style>
/* ================= VARIABLES & THEME ENGINE ================= */
:root {
  --bg-deep: #050505;
  --glass-panel: rgba(20, 20, 20, 0.6);
  --glass-border: rgba(255, 255, 255, 0.08);
  --glass-shine: rgba(255, 255, 255, 0.03);
  
  /* Default: Royal Gold */
  --primary: #D4AF37;
  --accent: #FFD700;
  --glow: rgba(212, 175, 55, 0.4);
  
  --font-brand: 'Cinzel', serif;
  --font-tech: 'Orbitron', sans-serif;
  --font-body: 'Inter', sans-serif;
  --font-code: 'JetBrains Mono', monospace;
  
  --ease: cubic-bezier(0.23, 1, 0.32, 1);
}

/* Theme Overrides */
[data-theme="cyber"] { --primary: #00f3ff; --accent: #fff; --glow: rgba(0, 243, 255, 0.4); }
[data-theme="crimson"] { --primary: #ff2a2a; --accent: #ff8888; --glow: rgba(255, 42, 42, 0.4); }
[data-theme="void"] { --primary: #bc13fe; --accent: #e088ff; --glow: rgba(188, 19, 254, 0.4); }

* { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg-deep); color: #fff; font-family: var(--font-body);
  height: 100dvh; display: flex; overflow: hidden; position: relative;
}

/* Animated Background Mesh */
.bg-mesh {
  position: absolute; inset: -50%; background: radial-gradient(circle at 50% 50%, var(--glow), transparent 60%);
  opacity: 0.15; animation: breathe 10s infinite alternate; z-index: 0; pointer-events: none;
}
@keyframes breathe { 0% { transform: scale(0.8); } 100% { transform: scale(1.2); } }

/* ================= 1. SPLASH SCREEN (Quantum Load) ================= */
#splash {
  position: fixed; inset: 0; background: #000; z-index: 9999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 1s var(--ease);
}
.splash-orbit {
  width: 80px; height: 80px; border: 2px solid rgba(255,255,255,0.1); border-radius: 50%;
  position: relative; animation: spin 4s linear infinite; display: flex; align-items: center; justify-content: center;
}
.splash-orbit::before {
  content:''; position: absolute; inset: -5px; border-radius: 50%;
  border-top: 3px solid var(--primary); border-right: 3px solid transparent;
  animation: spin 1.5s linear infinite;
}
.splash-core { width: 10px; height: 10px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 20px var(--primary); }
.splash-text {
  margin-top: 30px; font-family: var(--font-brand); font-size: 2rem; letter-spacing: 5px;
  background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; color: transparent;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ================= 2. APP LAYOUT (Glass Structure) ================= */
#app-container {
  position: relative; z-index: 10; display: flex; width: 100%; height: 100%;
  padding: 15px; gap: 15px; opacity: 0; transition: opacity 1s;
}

/* --- SIDEBAR --- */
.glass-sidebar {
  width: 280px; background: var(--glass-panel); border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px); border-radius: 20px; display: flex; flex-direction: column;
  transition: transform 0.4s var(--ease); overflow: hidden;
}
.sb-header { padding: 20px; border-bottom: 1px solid var(--glass-border); }
.sb-brand { font-family: var(--font-brand); font-size: 1.2rem; color: var(--primary); letter-spacing: 1px; }
.sb-status { font-family: var(--font-tech); font-size: 0.6rem; color: #666; letter-spacing: 2px; margin-top: 5px; }

.history-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
.hist-item {
  padding: 12px; border-radius: 12px; background: rgba(255,255,255,0.02); border: 1px solid transparent;
  cursor: pointer; font-size: 0.85rem; color: #aaa; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.hist-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
.hist-item.active { border-color: var(--primary); color: var(--primary); background: rgba(212, 175, 55, 0.05); }

.sb-footer { padding: 15px; border-top: 1px solid var(--glass-border); display: grid; gap: 10px; }
.btn-glass {
  background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #fff;
  padding: 12px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; font-weight: 600;
  display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s;
}
.btn-glass:hover { background: var(--primary); color: #000; border-color: var(--primary); }

/* --- MAIN INTERFACE --- */
.glass-main {
  flex: 1; background: var(--glass-panel); border: 1px solid var(--glass-border);
  backdrop-filter: blur(20px); border-radius: 20px; display: flex; flex-direction: column;
  overflow: hidden; position: relative;
}

/* Header */
.main-header {
  height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 25px;
  border-bottom: 1px solid var(--glass-border); background: rgba(0,0,0,0.2);
}
.avatar-group { display: flex; align-items: center; gap: 15px; cursor: pointer; }
.avatar-img { width: 42px; height: 42px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
.user-meta { line-height: 1.2; }
.user-name { font-weight: 600; font-size: 0.9rem; }
.user-role { font-size: 0.7rem; color: var(--primary); font-family: var(--font-tech); letter-spacing: 1px; }

.header-actions { display: flex; gap: 10px; }
.icon-btn {
  width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--glass-border);
  background: rgba(255,255,255,0.03); color: #ccc; cursor: pointer; transition: 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.icon-btn:hover { color: var(--primary); border-color: var(--primary); }

/* Chat Area */
#chat-view {
  flex: 1; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 25px;
}

/* NEURAL VISUALIZER (The "Thinking" Brain) */
#neural-viz {
  display: none; align-self: center; margin: 20px 0;
  width: 100%; max-width: 400px; height: 2px; background: #222; position: relative; overflow: hidden;
}
#neural-viz::after {
  content: ''; position: absolute; inset: 0; background: var(--primary);
  width: 30%; animation: scan 1.5s ease-in-out infinite alternate; box-shadow: 0 0 15px var(--primary);
}
@keyframes scan { from { left: 0; } to { left: 70%; } }

/* Bubbles */
.msg-row { display: flex; width: 100%; animation: floatUp 0.4s var(--ease); }
@keyframes floatUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

.msg-row.user { justify-content: flex-end; }
.msg-row.ai { justify-content: flex-start; }

.bubble {
  max-width: 80%; padding: 18px 22px; border-radius: 18px; font-size: 0.95rem; line-height: 1.6; position: relative;
}
.user .bubble {
  background: linear-gradient(135deg, var(--primary), rgba(0,0,0,0.8)); border: 1px solid var(--primary);
  color: #fff; border-bottom-right-radius: 4px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}
.ai .bubble {
  background: rgba(20,20,20,0.8); border: 1px solid rgba(255,255,255,0.1); color: #eee; border-bottom-left-radius: 4px;
}

/* Code */
pre { background: #080808; border-radius: 10px; border: 1px solid #333; margin-top: 10px; overflow: hidden; }
code { font-family: var(--font-code); padding: 15px; display: block; overflow-x: auto; font-size: 0.85rem; }
.code-bar {
  display: flex; justify-content: flex-end; background: #151515; padding: 5px; border-bottom: 1px solid #333; gap: 10px;
}
.tiny-btn { background: none; border: none; color: #888; font-size: 0.7rem; cursor: pointer; padding: 4px 8px; }
.tiny-btn:hover { color: #fff; }

/* Input Zone */
.input-dock {
  padding: 20px; background: rgba(0,0,0,0.4); border-top: 1px solid var(--glass-border);
}
.input-capsule {
  background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); border-radius: 16px;
  display: flex; align-items: center; padding: 8px; gap: 10px; transition: 0.3s;
}
.input-capsule:focus-within { border-color: var(--primary); background: rgba(0,0,0,0.6); }

#user-input { flex: 1; background: transparent; border: none; color: #fff; font-size: 1rem; padding: 8px; }
.attach-btn {
  width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.05);
  border: none; color: #aaa; cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.attach-btn:hover { background: #333; color: #fff; }

.send-orb {
  width: 45px; height: 45px; border-radius: 12px; background: var(--primary);
  border: none; color: #000; font-size: 1.2rem; cursor: pointer; box-shadow: 0 0 15px var(--glow);
  display: flex; align-items: center; justify-content: center; transition: transform 0.2s;
}
.send-orb:hover { transform: scale(1.05); }

/* ================= 3. SETTINGS & DASHBOARD MODAL ================= */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
  z-index: 5000; display: none; align-items: center; justify-content: center;
}
.modal-backdrop.open { display: flex; animation: fadeModal 0.3s; }
@keyframes fadeModal { from { opacity: 0; } to { opacity: 1; } }

.dashboard-card {
  width: 90%; max-width: 800px; height: 80vh; background: #0a0a0a; border: 1px solid #333;
  border-radius: 24px; display: flex; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.7);
}

/* Dashboard Sidebar */
.dash-nav { width: 200px; background: #111; border-right: 1px solid #222; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
.dash-btn {
  background: transparent; color: #888; border: none; padding: 12px; text-align: left;
  border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
}
.dash-btn.active { background: var(--primary); color: #000; }

/* Dashboard Content */
.dash-content { flex: 1; padding: 30px; overflow-y: auto; }
.dash-section { display: none; }
.dash-section.active { display: block; animation: slideRight 0.3s; }
@keyframes slideRight { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

.setting-row { margin-bottom: 20px; }
.setting-label { display: block; color: var(--primary); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 8px; }
.setting-input {
  width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 12px;
  border-radius: 8px; color: #fff; font-family: var(--font-body);
}

/* Color Pickers */
.theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
.theme-opt { height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; opacity: 0.6; }
.theme-opt.active { opacity: 1; border-color: #fff; transform: scale(1.05); }

/* Hidden inputs */
#file-input, #cam-input, #avatar-upload { display: none; }

/* Mobile Menu */
@media(max-width: 800px) {
  .glass-sidebar { position: fixed; inset: 0 auto 0 0; transform: translateX(-100%); z-index: 200; width: 300px; }
  .glass-sidebar.open { transform: translateX(0); }
  .dashboard-card { flex-direction: column; height: 90vh; }
  .dash-nav { width: 100%; flex-direction: row; overflow-x: auto; height: 70px; }
  .dash-btn { white-space: nowrap; }
}
</style>
</head>
<body>

<div class="bg-mesh"></div>

<div id="splash">
  <div class="splash-orbit"><div class="splash-core"></div></div>
  <div class="splash-text">Ai Studio</div>
</div>

<div id="app-container">
  
  <aside class="glass-sidebar" id="sidebar">
    <div class="sb-header">
      <div class="sb-brand">AI STUDIO</div>
      <div class="sb-status">SYSTEM OPERATIONAL</div>
    </div>
    <div class="history-list" id="history-list">
      </div>
    <div class="sb-footer">
      <button class="btn-glass" onclick="startNewChat()"><i class="fa-solid fa-plus"></i> NEW OPERATION</button>
      <button class="btn-glass" onclick="toggleDashboard()"><i class="fa-solid fa-sliders"></i> DASHBOARD</button>
    </div>
  </aside>

  <main class="glass-main">
    
    <header class="main-header">
      <button class="icon-btn" onclick="toggleSidebar()" style="margin-right:15px; display:none;" id="mobile-menu"><i class="fa-solid fa-bars"></i></button>
      
      <div class="avatar-group" onclick="toggleDashboard()">
        <img src="" id="user-avatar" class="avatar-img">
        <div class="user-meta">
          <div class="user-name" id="disp-name">User</div>
          <div class="user-role" id="disp-title">Admin</div>
        </div>
      </div>

      <div class="header-actions">
        <button class="icon-btn" onclick="exportData()" title="Backup Data"><i class="fa-solid fa-download"></i></button>
        <button class="icon-btn" onclick="generatePDF()" title="PDF Report"><i class="fa-solid fa-file-pdf"></i></button>
      </div>
    </header>

    <div id="chat-view">
      <div class="msg-row ai">
        <div class="bubble">
          <strong>Quantum Core Online.</strong><br>
          Select a mode or upload a file to begin analysis.
        </div>
      </div>
    </div>

    <div id="neural-viz"></div>

    <div class="input-dock">
      <div id="file-preview" style="margin-bottom:10px; color:#aaa; font-size:0.8rem; display:none;"></div>
      
      <div class="input-capsule">
        <button class="attach-btn" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-paperclip"></i></button>
        <input type="file" id="file-input" onchange="handleFile(this)">
        
        <button class="attach-btn" onclick="document.getElementById('cam-input').click()"><i class="fa-solid fa-camera"></i></button>
        <input type="file" id="cam-input" accept="image/*" capture="environment" onchange="handleFile(this)">
        
        <input type="text" id="user-input" placeholder="Input Command..." autocomplete="off">
        
        <button class="send-orb" onclick="sendMessage()"><i class="fa-solid fa-arrow-up"></i></button>
      </div>
    </div>
  </main>
</div>

<div id="dashboard" class="modal-backdrop">
  <div class="dashboard-card">
    <div class="dash-nav">
      <button class="dash-btn active" onclick="switchTab('profile')">Profile</button>
      <button class="dash-btn" onclick="switchTab('system')">System</button>
      <button class="dash-btn" onclick="switchTab('appearance')">Appearance</button>
      <button class="dash-btn" style="color:#ff5555; margin-top:auto;" onclick="toggleDashboard()">Close</button>
    </div>
    
    <div class="dash-content">
      
      <div id="tab-profile" class="dash-section active">
        <h2 style="margin-bottom:20px; font-family:var(--font-brand);">User Configuration</h2>
        
        <div class="setting-row">
          <label class="setting-label">Identity Avatar</label>
          <img src="" id="dash-avatar" style="width:80px; height:80px; border-radius:50%; cursor:pointer; border:2px solid var(--primary);" onclick="document.getElementById('avatar-upload').click()">
          <input type="file" id="avatar-upload" accept="image/*" onchange="updateAvatar(this)">
        </div>

        <div class="setting-row">
          <label class="setting-label">Display Name</label>
          <input type="text" id="conf-name" class="setting-input">
        </div>
        
        <div class="setting-row">
          <label class="setting-label">Role Title</label>
          <input type="text" id="conf-title" class="setting-input">
        </div>

        <button class="btn-glass" style="width:100%; justify-content:center;" onclick="saveConfig()">SAVE CHANGES</button>
      </div>

      <div id="tab-system" class="dash-section">
        <h2 style="margin-bottom:20px; font-family:var(--font-brand);">Neural Bridge</h2>
        
        <div class="setting-row">
          <label class="setting-label">API Key (OpenRouter / OpenAI)</label>
          <input type="password" id="conf-key" class="setting-input" placeholder="sk-...">
        </div>

        <div class="setting-row">
          <label class="setting-label">AI Persona</label>
          <select id="conf-persona" class="setting-input">
            <option value="default">Default Assistant</option>
            <option value="coder">Senior Engineer</option>
            <option value="quantum">Quantum Analyst (Logical)</option>
          </select>
        </div>
        
        <div class="setting-row">
          <label class="setting-label">System Status</label>
          <div style="background:#111; padding:15px; border-radius:8px; font-family:var(--font-code); font-size:0.8rem; color:#888;">
            <div>> CORE: ONLINE</div>
            <div>> LATENCY: <span style="color:#0f0">12ms</span></div>
            <div>> MEMORY: OPTIMAL</div>
          </div>
        </div>
        
        <button class="btn-glass" style="width:100%; justify-content:center;" onclick="saveConfig()">CONNECT BRIDGE</button>
      </div>

      <div id="tab-appearance" class="dash-section">
        <h2 style="margin-bottom:20px; font-family:var(--font-brand);">Visual Engine</h2>
        <div class="setting-row">
          <label class="setting-label">Theme Accent</label>
          <div class="theme-grid">
            <div class="theme-opt" style="background:#D4AF37;" onclick="setTheme('gold')"></div>
            <div class="theme-opt" style="background:#00f3ff;" onclick="setTheme('cyber')"></div>
            <div class="theme-opt" style="background:#ff2a2a;" onclick="setTheme('crimson')"></div>
            <div class="theme-opt" style="background:#bc13fe;" onclick="setTheme('void')"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// ================= CONTROLLER =================
const App = {
  state: {
    user: { name: "Shikhar Traders", title: "Admin", avatar: "https://ui-avatars.com/api/?name=ST&background=D4AF37&color=000", apiKey: "" },
    chats: [],
    activeChatId: null,
    theme: 'gold'
  },
  
  init() {
    this.load();
    this.checkWidth();
    
    // Splash
    setTimeout(() => {
      document.getElementById('splash').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('splash').style.display = 'none';
        document.getElementById('app-container').style.opacity = '1';
      }, 1000);
    }, 2000);

    // Event Listeners
    window.addEventListener('resize', this.checkWidth);
    document.getElementById('user-input').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') sendMessage();
    });
    
    // Setup Highlight
    hljs.highlightAll();
  },

  load() {
    const saved = localStorage.getItem('elite_quantum_v8');
    if(saved) this.state = JSON.parse(saved);
    
    // Apply UI
    document.getElementById('user-avatar').src = this.state.user.avatar;
    document.getElementById('dash-avatar').src = this.state.user.avatar;
    document.getElementById('disp-name').innerText = this.state.user.name;
    document.getElementById('disp-title').innerText = this.state.user.title;
    
// Fill Config
    document.getElementById('conf-name').value = this.state.user.name;
    document.getElementById('conf-title').value = this.state.user.title;
    document.getElementById('conf-key').value = this.state.user.apiKey;
    
    setTheme(this.state.theme);
    renderHistory();
    
    if(!this.state.user.apiKey) setTimeout(toggleDashboard, 3500);
  },

  save() {
    localStorage.setItem('elite_quantum_v8', JSON.stringify(this.state));
  },
  
  checkWidth() {
    if(window.innerWidth < 800) {
      document.getElementById('mobile-menu').style.display = 'flex';
    } else {
      document.getElementById('mobile-menu').style.display = 'none';
      document.getElementById('sidebar').classList.remove('open');
    }
  }
};

let pendingFile = null;

// ================= LOGIC FUNCTIONS =================

function startNewChat() {
  const id = Date.now().toString();
  App.state.chats.unshift({ id, title: "New Operation", msgs: [] });
  App.state.activeChatId = id;
  App.save();
  renderHistory();
  document.getElementById('chat-view').innerHTML = ''; // Clear View
  addBubble('ai', 'Operation started. Awaiting input.');
}

function renderHistory() {
  const list = document.getElementById('history-list');
  list.innerHTML = '';
  App.state.chats.forEach(chat => {
    const el = document.createElement('div');
    el.className = `hist-item ${chat.id === App.state.activeChatId ? 'active' : ''}`;
    el.innerText = chat.title;
    el.onclick = () => loadChat(chat.id);
    list.appendChild(el);
  });
}

function loadChat(id) {
  App.state.activeChatId = id;
  const chat = App.state.chats.find(c => c.id === id);
  const view = document.getElementById('chat-view');
  view.innerHTML = '';
  chat.msgs.forEach(m => addBubble(m.role, m.content, false));
  renderHistory();
  if(window.innerWidth < 800) toggleSidebar();
}

// ================= MESSAGING =================
async function sendMessage() {
  const input = document.getElementById('user-input');
  const text = input.value.trim();
  
  if(!text && !pendingFile) return;
  if(!App.state.user.apiKey) { toggleDashboard(); switchTab('system'); return; }

  // 1. Prepare User Payload
  let dispText = text;
  let apiContent = [];
  if(text) apiContent.push({ type: "text", text });

  if(pendingFile) {
    dispText += `<br><span style="font-size:0.8rem; color:#aaa;">[Attached: ${pendingFile.name}]</span>`;
    if(pendingFile.type.startsWith('image')) {
      apiContent.push({ type: "image_url", image_url: { url: pendingFile.data } });
      dispText += `<br><img src="${pendingFile.data}" style="max-width:100%; border-radius:10px; margin-top:10px;">`;
    } else {
      apiContent.push({ type: "text", text: `\n[FILE CONTENT]:\n${pendingFile.data}` });
    }
    clearFile();
  }

  // 2. Add User Bubble & Save
  addBubble('user', dispText);
  saveMsg('user', dispText);
  input.value = '';

  // 3. Show Neural Viz
  document.getElementById('neural-viz').style.display = 'block';
  document.getElementById('chat-view').scrollTop = document.getElementById('chat-view').scrollHeight;

  // 4. API Call
  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: { "Authorization": `Bearer ${App.state.user.apiKey}`, "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "openai/gpt-4o-mini",
        messages: [{ role: "system", content: "You are Elite Quantum AI. Highly intelligent, precise, and professional." }, { role: "user", content: apiContent }]
      })
    });
    
    const data = await res.json();
    const reply = data.choices[0].message.content;
    
    // Hide Viz
    document.getElementById('neural-viz').style.display = 'none';
    
    let isWhiteboard = false;
    if(reply.includes("latex") || reply.includes("$$")) isWhiteboard = true;

    addBubble('ai', reply, isWhiteboard);
    saveMsg('ai', reply);
    
    // Auto-Title
    const chat = App.state.chats.find(c => c.id === App.state.activeChatId);
    if(chat && chat.msgs.length <= 2) {
      chat.title = text.substring(0, 20) || "Image Analysis";
      App.save();
      renderHistory();
    }

  } catch(e) {
    document.getElementById('neural-viz').style.display = 'none';
    addBubble('ai', "Error: " + e.message);
  }
}

function saveMsg(role, content) {
  if(!App.state.activeChatId) startNewChat();
  const chat = App.state.chats.find(c => c.id === App.state.activeChatId);
  chat.msgs.push({ role, content });
  App.save();
}

function addBubble(role, html, isWB) {
  const view = document.getElementById('chat-view');
  const row = document.createElement('div');
  row.className = `msg-row ${role}`;
  
  const b = document.createElement('div');
  b.className = `bubble ${isWB ? 'whiteboard' : ''}`;
  
  if(role === 'ai') {
    b.innerHTML = marked.parse(html);
    b.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    b.querySelectorAll('pre').forEach(pre => {
      const code = pre.querySelector('code').innerText;
      const bar = document.createElement('div');
      bar.className = 'code-bar';
      bar.innerHTML = `<button class="tiny-btn" onclick="navigator.clipboard.writeText(decodeURIComponent('${encodeURIComponent(code)}'))">COPY CODE</button>`;
      pre.insertBefore(bar, pre.firstChild);
    });
  } else {
    b.innerHTML = html;
  }
  
  row.appendChild(b);
  view.appendChild(row);
  view.scrollTop = view.scrollHeight;
}

// ================= TOOLS =================
function handleFile(input) {
  if(input.files[0]) {
    const f = input.files[0];
    const reader = new FileReader();
    reader.onload = (e) => {
      pendingFile = { name: f.name, type: f.type, data: e.target.result };
      const prev = document.getElementById('file-preview');
      prev.style.display = 'block';
      prev.innerHTML = `<i class="fa-solid fa-paperclip"></i> ${f.name} (Ready)`;
    };
    if(f.type.startsWith('image')) reader.readAsDataURL(f); else reader.readAsText(f);
  }
}

function clearFile() {
  pendingFile = null;
  document.getElementById('file-preview').style.display = 'none';
  document.getElementById('file-input').value = '';
}

// ================= DASHBOARD =================
function toggleDashboard() {
  const db = document.getElementById('dashboard');
  if(db.style.display === 'flex') db.style.display = 'none';
  else db.style.display = 'flex';
}

function switchTab(tabId) {
  document.querySelectorAll('.dash-section').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-'+tabId).classList.add('active');
  document.querySelectorAll('.dash-btn').forEach(el => el.classList.remove('active'));
  event.target.classList.add('active');
}

function updateAvatar(input) {
  if(input.files[0]) {
    const r = new FileReader();
    r.onload = (e) => {
      document.getElementById('dash-avatar').src = e.target.result;
    };
    r.readAsDataURL(input.files[0]);
  }
}

function saveConfig() {
  App.state.user.name = document.getElementById('conf-name').value;
  App.state.user.title = document.getElementById('conf-title').value;
  App.state.user.apiKey = document.getElementById('conf-key').value;
  App.state.user.avatar = document.getElementById('dash-avatar').src;
  App.save();
  toggleDashboard();
  App.load(); // Refresh UI
}

function setTheme(name) {
  App.state.theme = name;
  document.body.setAttribute('data-theme', name);
  App.save();
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

function exportData() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(App.state));
  const node = document.createElement('a');
  node.href = dataStr;
  node.download = "elite_backup.json";
  node.click();
}

function generatePDF() {
  if(!window.jspdf) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFont("courier");
  doc.text("QUANTUM REPORT", 10, 10);
  doc.save("Report.pdf");
}

App.init();
</script>
</body>
</html>